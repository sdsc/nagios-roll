<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
nagios roll installation test.
</description>

<copyright>
Copyright (c) 2000 - 2011 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<post>

/bin/mkdir -m 0755 /root/rolltests

<file name="/root/rolltests/nagios.t" perms="0755">
<![CDATA[#!/usr/bin/perl -w

use Test::More qw(no_plan);

my $appliance = $#ARGV >= 0 ? $ARGV[0] :
                -d '/export/rocks/install' ? 'Frontend' : 'Compute';
my $isCompute = $appliance eq 'Compute';
my $isFe = $appliance eq 'Frontend';
my $isLogin = $appliance eq 'Login';
my $output;

# nagios-server.xml
SKIP: {

  skip 'not server', 9 if ! $isFe;
  ok(-d '/opt/nagios', 'nagios installed');
  $output = `id nagios 2>&1`;
  like($output, qr/apache/, 'nagios group membership');
  $output = `service nagios status 2>&1`;
  ok($? == 0, 'nagios service defined');
  like($output, qr/running/, 'nagios running');
  ok(-d '/opt/nagios/var/rw', 'nagios runtime dir');
  ok(-f '/etc/httpd/conf.d/nagios.conf', 'nagios web conf');
  $output = `rocks dump nagios 2>&1`;
  ok($? == 0, 'nagios rocks commands defined');
  like($output, qr/administrators/, 'nagios default contact defined');
  like($output, qr/PING/, 'ping service defined');

}

# nsca-client.xml
ok(-f '/opt/nagios/bin/nsca', 'nsca installed');
$output = `id nagios 2>&1`;
ok($? == 0, 'nagios login defined');
like($output, qr/uid=413/, 'nagios uid');
ok(-f '/opt/nagios/bin/nsca_schedule', 'nsca_schedule installed');
ok(-f '/opt/nagios/bin/nsca_check', 'nsca_check installed');

# nsca-server.xml
SKIP: {
  skip 'not server', 2 if ! $isFe;
  ok(-f '/etc/xinetd.d/nsca', 'nsca daemon installed');
  $output = `rocks list attr | grep NSCA_ServerName`;
  like($output, qr/NSCA_ServerName/, 'nsca attr set');
}

]]>
</file>

</post>

</kickstart> 
