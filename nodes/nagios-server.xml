<?xml version="1.0" standalone="no"?>

<kickstart>

  <description>
  Nagios system monitor
  </description>

  <copyright>
  Copyright (c) 2000 - 2008 The Regents of the University of California.
  All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
  </copyright>

  <changelog>
  $Log$
  Revision 1.10  2009/03/30 21:16:58  jhayes
  Debugging.

  Revision 1.9  2009/03/30 19:29:42  jhayes
  Split nagios service manipluation into separate commands.  Remove all add
  arguments in favor of named params.  Lotsa code improvements.

  Revision 1.8  2009/03/28 00:40:39  jhayes
  More debugging.

  Revision 1.7  2009/03/27 22:58:28  jhayes
  Debugging.

  Revision 1.6  2009/03/26 21:26:49  jhayes
  Begin working on using rocks command to manipulate nagios config.

  Revision 1.5  2009/03/25 18:39:47  jhayes
  Prep work for adding object configuration.  A bug fix or two.

  </changelog>

  <package>nagios</package>
  <package>nagios-plugins</package>
  <package>rocks-command-nagios</package>

  <post>

  <!--
    # JJH: see http://nagios.sourceforge.net/docs/3_0/quickstart-fedora.html
  -->

  <!--
    # JJH: replaced <= gbruno
    # Create a new nagios user account and give it a password.
    /usr/sbin/useradd -m nagios
  -->
  /usr/sbin/useradd -M -u413 -c "Nagios Monitoring" -d /opt/nagios nagios

  <!--
    # JJH: Unneeded: use apache group directly instead
    # Create a new nagcmd group for allowing external commands to be submitted
    # through the web interface. Add both the nagios user and the apache user
    # to the group.
    /usr/sbin/groupadd nagcmd
    /usr/sbin/usermod -a -G nagcmd apache
    /usr/sbin/usermod -a -G nagcmd nagios

    # JJH: Done by roll build; ==with-command-group defaults to nagios
    # Run the Nagios configure script, passing the name of the group you
    # created earlier like so:
    ./configure ==with-command-group=nagcmd
    make all
    make install

    # JJH: Must inline here, since Makefile unavailable during installation
  -->
  <!-- make install-config -->
  <file name="/opt/nagios/etc/cgi.cfg"
        expr="/bin/cat /opt/nagios/etc/sample-config/cgi.cfg"/>
  <!-- make install-init -->
  <file name="/etc/rc.d/init.d/nagios"
        expr="/bin/cat /opt/nagios/etc/daemon-init" perms="0755"/>
  <!-- make install-commandmode -->
  /bin/mkdir /opt/nagios/var/rw
  chmod g+s /opt/nagios/var/rw
  <!-- make install-webconf -->
  <file name="/etc/httpd/conf.d/nagios.conf"
        expr="/bin/cat /opt/nagios/etc/httpd.conf" perms="0644"/>

  <!--
    # JJH: not needed
    # Replace nagios@localhost w/the email specified at installation
    vi /opt/nagios/etc/objects/contacts.cfg

    # JJH: replaced <= gbruno; I used nagiosadmin (default) instead of nagios
    # Create a nagiosadmin account for logging into the Nagios web interface.
    # Remember the password you assign to this account - you'll need it later.
    htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
  -->
  <file name="/opt/nagios/etc/htpasswd.users" perms="0644">
nagiosadmin:<var name="Kickstart_PrivateRootPassword"/>
  </file>

  <!--
    # JJH: not needed
    # Restart Apache to make the new settings take effect.
    service httpd restart

    # JJH: Handled by Makefile; opts default to nagios
    # Compile and install the plugins.
    ./configure ==with-nagios-user=nagios ==with-nagios-group=nagios
    make
    make install

    </file>
  -->

  <!--
    # JJH: add configuration
  -->
  <file name="/opt/nagios/etc/nagios.cfg" perms="0644">
##
## ROCKS
##

cfg_dir=/opt/nagios/etc/rocks
  </file>

  /bin/mkdir -p /opt/nagios/etc/rocks
  /opt/rocks/bin/rocks add nagios contact \
    email='<var name="Info_ClusterContact"/>' \
    groups='administrators'
  /opt/rocks/bin/rocks add nagios host \
    name='<var name="Kickstart_PrivateHostname"/>' \
    ip='<var name="Kickstart_PrivateAddress"/>' \
    contacts='administrators' \
    groups='all-hosts'
  /opt/rocks/bin/rocks add nagios service \
    name='PING' hosts='all-hosts' \
    command='check_ping!100.0,20%!500.0,60%' \
    contacts='administrators'

  <!--
    # JJH: Not needed
    chkconfig ==add nagios

    # JJH: create ssh key so nagios won't prompt for passphrase
  -->
  mkdir -p /opt/nagios/.ssh
  ssh-keygen -q -f /opt/nagios/.ssh/id_rsa -N ''

  chown -R nagios.apache /opt/nagios
  chkconfig nagios on

  <!--
    # JJH: not needed
    # Verify the sample Nagios configuration files.
    /opt/nagios/bin/nagios -v /opt/nagios/etc/nagios.cfg
    # If there are no errors, start Nagios.
    service nagios start
  -->

  </post>

</kickstart>
