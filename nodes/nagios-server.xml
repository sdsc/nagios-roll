<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
Nagios system monitor
http://www.nagios.org
</description>

<copyright>
Copyright (c) 2000 - 2011 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<package>nagios</package>
<package>nagios-plugins</package>
<package>nagios-roll-test</package>
<package>rocks-command-nagios</package>

<post>

<!-- see http://nagios.sourceforge.net/docs/3_0/quickstart-fedora.html -->
/usr/sbin/useradd -M -u413 -c "Nagios Monitoring" -d /opt/nagios nagios -G apache

<!--
  NOTE: Unneeded: we use apache group directly instead
  # Create a new nagcmd group for allowing external commands to be submitted
  # through the web interface. Add both the nagios user and the apache user
  # to the group.
  /usr/sbin/groupadd nagcmd
  /usr/sbin/usermod -a -G nagcmd apache
  /usr/sbin/usermod -a -G nagcmd nagios

  NOTE: Done by roll build; ==with-command-group defaults to nagios
  # Run the Nagios configure script, passing the name of the group you
  # created earlier like so:
  ./configure ==with-command-group=nagcmd
  make all
  make install
  make install-config

  NOTE: inline make steps here, since Makefile unavailable during installation
-->

cp /opt/nagios/etc/daemon-init /etc/rc.d/init.d/nagios
chmod 0755 /etc/rc.d/init.d/nagios

<!-- make install-commandmode -->
mkdir -p /opt/nagios/var/rw
chmod g+s /opt/nagios/var/rw
<!-- make install-webconf -->
cp /opt/nagios/etc/httpd.conf /etc/httpd/conf.d/nagios.conf
chmod 0644 /etc/httpd/conf.d/nagios.conf

<!--
  NOTE: not needed
  # Replace nagios@localhost w/the email specified at installation
  vi /opt/nagios/etc/objects/contacts.cfg

  NOTE: replaced
  # Create a nagiosadmin account for logging into the Nagios web interface.
  # Remember the password you assign to this account - you'll need it later.
  htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
-->
<file name="/opt/nagios/etc/htpasswd.users" perms="0644">
nagiosadmin:&Kickstart_PrivateRootPassword;
</file>

<!--
  NOTE: not needed
  # Restart Apache to make the new settings take effect.
  service httpd restart

  NOTE: Handled by Makefile; opts default to nagios
  # Compile and install the plugins.
  ./configure ==with-nagios-user=nagios ==with-nagios-group=nagios
  make
  make install
-->

<!--
  # add configuration
-->
<file name="/opt/nagios/etc/nagios.cfg" perms="0644">
##
## ROCKS
##

cfg_dir=/opt/nagios/etc/rocks
illegal_macro_output_chars=`~$^&amp;"|'&lt;&gt;
log_file=/opt/nagios/var/nagios.log
</file>

/bin/mkdir -p /opt/nagios/etc/rocks
/opt/rocks/bin/rocks add nagios contact \
  email='&Info_ClusterContact;' \
  groups='administrators'
/opt/rocks/bin/rocks add nagios host \
  name='&Kickstart_PrivateHostname;' \
  ip='&Kickstart_PrivateAddress;' \
  contacts='administrators' \
  groups='allhosts'
/opt/rocks/bin/rocks add nagios service \
  name='PING' hosts='allhosts' \
  command='check_ping -H $HOSTADDRESS$ -w 3000.0,80% -c 5000.0,100% -p 5' \
  contacts='administrators'

<!--
  NOTE: Not needed
  chkconfig ==add nagios

  NOTE: create ssh key so nagios won't prompt for passphrase
-->
/bin/mkdir -p /opt/nagios/.ssh
/usr/bin/ssh-keygen -q -f /opt/nagios/.ssh/id_rsa -N ''

/bin/chown -R nagios.apache /opt/nagios
/sbin/chkconfig nagios on

<!--
  NOTE: not needed
  # Verify the sample Nagios configuration files.
  /opt/nagios/bin/nagios -v /opt/nagios/etc/nagios.cfg
  # If there are no errors, start Nagios.
  service nagios start
-->

</post>

</kickstart>
